
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pharmpy.methods.frem.results &#8212; Pharmpy 0.20.1 documentation</title>
    
  <link rel="stylesheet" href="../../../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script src="../../../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../../../index.html">
    
      <p class="title">Pharmpy</p>
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../getting_started.html">Getting started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../user_guide.html">User guide</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../reference/modules.html">API reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../contribute.html">Contribute</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../changelog.html">Changelog</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../license.html">License</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3><a href="../../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/modules.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>

          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pharmpy.methods.frem.results</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">altair</span> <span class="k">as</span> <span class="nn">alt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">symengine</span>

<span class="kn">import</span> <span class="nn">pharmpy.symbols</span> <span class="k">as</span> <span class="nn">symbols</span>
<span class="kn">from</span> <span class="nn">pharmpy</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">pharmpy.data</span> <span class="kn">import</span> <span class="n">ColumnType</span>
<span class="kn">from</span> <span class="nn">pharmpy.math</span> <span class="kn">import</span> <span class="n">conditional_joint_normal</span><span class="p">,</span> <span class="n">is_posdef</span>
<span class="kn">from</span> <span class="nn">pharmpy.parameter_sampling</span> <span class="kn">import</span> <span class="n">sample_from_covariance_matrix</span><span class="p">,</span> <span class="n">sample_individual_estimates</span>
<span class="kn">from</span> <span class="nn">pharmpy.random_variables</span> <span class="kn">import</span> <span class="n">VariabilityLevel</span>
<span class="kn">from</span> <span class="nn">pharmpy.results</span> <span class="kn">import</span> <span class="n">Results</span>


<div class="viewcode-block" id="FREMResults"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.FREMResults">[docs]</a><span class="k">class</span> <span class="nc">FREMResults</span><span class="p">(</span><span class="n">Results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FREM Results class</span>

<span class="sd">    What follows is a description on how the FREM results are stored.</span>
<span class="sd">    See :py:mod:`pharmpy.methods.frem` for a description of how the results are calculated.</span>

<span class="sd">    .. attribute:: covariate_baselines</span>

<span class="sd">        DataFrame with the baseline covariate values used in the analysis for each indiviual.</span>
<span class="sd">        Index is ID. One column for each covariate.</span>

<span class="sd">        .. code-block::</span>

<span class="sd">                  WGT  APGR</span>
<span class="sd">            ID</span>
<span class="sd">            1.0   1.4   7.0</span>
<span class="sd">            2.0   1.5   9.0</span>
<span class="sd">            3.0   1.5   6.0</span>
<span class="sd">            4.0   0.9   6.0</span>
<span class="sd">            5.0   1.4   7.0</span>
<span class="sd">            6.0   1.2   5.0</span>
<span class="sd">            7.0   1.0   5.0</span>
<span class="sd">            8.0   1.2   7.0</span>
<span class="sd">            9.0   1.4   8.0</span>
<span class="sd">            ...   ...   ...</span>


<span class="sd">    .. attribute:: covariate_effects</span>

<span class="sd">        DataFrame with covariate effects. Index is parameter, covariate and condition where</span>
<span class="sd">        condition can be either 5th or 95th. Columns are p5, mean and p95 for the 5th</span>
<span class="sd">        percentile of the effect, the estimated effect and the 95th percentile of the effect</span>
<span class="sd">        respectively. Effect sizes are in fractions. Example:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">                                                 p5      mean       p95</span>
<span class="sd">            parameter covariate condition</span>
<span class="sd">            ETA(1)    WGT       5th        0.901869  0.972920  1.051093</span>
<span class="sd">                                95th       0.903849  1.064605  1.233111</span>
<span class="sd">                      APGR      5th        1.084238  1.248766  1.413923</span>
<span class="sd">                                95th       0.848297  0.901919  0.962312</span>
<span class="sd">            ETA(2)    WGT       5th        0.942450  1.004400  1.068390</span>
<span class="sd">                                95th       0.874409  0.995763  1.127777</span>
<span class="sd">                      APGR      5th        0.832008  0.924457  1.021307</span>
<span class="sd">                                95th       0.990035  1.039444  1.091288</span>

<span class="sd">    .. attribute:: covariate_effects_plot</span>

<span class="sd">        Plot of the covariate effects generated by :py:meth:`plot_covariate_effects`</span>

<span class="sd">    .. attribute:: covariate_statistics</span>

<span class="sd">        DataFrame with summary statistics of the covariate baselines. Index is covariates.</span>
<span class="sd">        Columns are p5 with 95th percentile, mean, p95 with 95th percentile, stdev, ref with</span>
<span class="sd">        the used reference value, categorical and other with the non-reference value for</span>
<span class="sd">        categorical covariates. Example:</span>

<span class="sd">        .. code-block</span>

<span class="sd">                                    p5      mean  p95     stdev       ref  categorical  other</span>
<span class="sd">                        covariate</span>
<span class="sd">                        WGT        0.7  1.525424  3.2  0.704565  1.525424        False    NaN</span>
<span class="sd">                        APGR       1.0  6.423729  9.0  2.237636  6.423729        False    NaN</span>

<span class="sd">    .. attribute:: individual_effects</span>

<span class="sd">        DataFrame with individual covariate effects. Index is ID and parameter. Columns</span>
<span class="sd">        are observed, p5 and p95 for the observed individual effect, 5th and 95th</span>
<span class="sd">        percentiles of the estimated individual effects respectively. Example:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">                            observed        p5       p95</span>
<span class="sd">            ID   parameter</span>
<span class="sd">            1.0  ETA(1)     0.973309  0.946282  0.982391</span>
<span class="sd">                 ETA(2)     1.009411  0.995276  1.024539</span>
<span class="sd">            2.0  ETA(1)     0.911492  0.832168  0.941760</span>
<span class="sd">                 ETA(2)     1.036200  0.990081  1.091438</span>
<span class="sd">            3.0  ETA(1)     1.013772  1.007555  1.028463</span>
<span class="sd">            ...                  ...       ...       ...</span>
<span class="sd">            57.0 ETA(2)     0.987500  0.942709  1.031111</span>
<span class="sd">            58.0 ETA(1)     0.939409  0.883782  0.956792</span>
<span class="sd">                 ETA(2)     1.023321  0.993543  1.057408</span>
<span class="sd">            59.0 ETA(1)     0.992578  0.952785  1.027261</span>
<span class="sd">                 ETA(2)     0.999220  0.968931  1.033819</span>

<span class="sd">    .. attribute:: individual_effects_plot</span>

<span class="sd">        Plot of the individual effects generated by :py:meth:`plot_individual_effects`</span>

<span class="sd">    .. attribute:: unexplained_variability</span>

<span class="sd">        DataFrame with remaining unexplained variability. Index is parameter and covariate.</span>
<span class="sd">        Covariate is none for no covariates and all for all covariates. Example:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">                                 sd_observed    sd_5th   sd_95th</span>
<span class="sd">            parameter covariate</span>
<span class="sd">            ETA(1)    none          0.195327  0.221382  0.298465</span>
<span class="sd">                      WGT           0.194527  0.218385  0.292261</span>
<span class="sd">                      APGR          0.182497  0.202192  0.279766</span>
<span class="sd">                      all           0.178956  0.197282  0.268090</span>
<span class="sd">            ETA(2)    none          0.158316  0.152510  0.210044</span>
<span class="sd">                      WGT           0.158313  0.148041  0.207276</span>
<span class="sd">                      APGR          0.155757  0.149037  0.203477</span>
<span class="sd">                      all           0.155551  0.144767  0.201658</span>

<span class="sd">    .. attribute:: unexplained_variability_plot</span>

<span class="sd">        Plot of the unexplained variability generated by :py:meth:`plot_unexplained_variability`</span>

<span class="sd">    .. attribute:: parameter_inits_and_estimates</span>

<span class="sd">        Initial parameter estimates and estimates after fitting for all intermediate models and</span>
<span class="sd">        the final model.</span>

<span class="sd">    .. attribute:: base_parameter_change</span>

<span class="sd">        The relative change in parameter estimates from base model to the FREM model.</span>

<span class="sd">    .. attribute:: covariate_estimates</span>

<span class="sd">        Model estimates of covariate statistics</span>

<span class="sd">    .. attribute:: parameter_variability</span>

<span class="sd">        Conditioned parameter variability</span>

<span class="sd">    .. attribute:: coefficients</span>

<span class="sd">        Parameter covariate coefficients. Calculated one at a time or all together.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rst_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;report.rst&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coefficients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parameter_variability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covariate_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">individual_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unexplained_variability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covariate_statistics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covariate_effects_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">individual_effects_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unexplained_variability_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covariate_baselines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parameter_inits_and_estimates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">base_parameter_change</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">estimated_covariates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ofv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># FIXME: Lots of boilerplate code ahead. Could be simplified with python 3.7 dataclass</span>
        <span class="c1">#        or namedtuple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_variability</span> <span class="o">=</span> <span class="n">parameter_variability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_effects</span> <span class="o">=</span> <span class="n">covariate_effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">individual_effects</span> <span class="o">=</span> <span class="n">individual_effects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexplained_variability</span> <span class="o">=</span> <span class="n">unexplained_variability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_statistics</span> <span class="o">=</span> <span class="n">covariate_statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_effects_plot</span> <span class="o">=</span> <span class="n">covariate_effects_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">individual_effects_plot</span> <span class="o">=</span> <span class="n">individual_effects_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexplained_variability_plot</span> <span class="o">=</span> <span class="n">unexplained_variability_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_baselines</span> <span class="o">=</span> <span class="n">covariate_baselines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_inits_and_estimates</span> <span class="o">=</span> <span class="n">parameter_inits_and_estimates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_parameter_change</span> <span class="o">=</span> <span class="n">base_parameter_change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofv</span> <span class="o">=</span> <span class="n">ofv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimated_covariates</span> <span class="o">=</span> <span class="n">estimated_covariates</span>

<div class="viewcode-block" id="FREMResults.add_plots"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.FREMResults.add_plots">[docs]</a>    <span class="k">def</span> <span class="nf">add_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_effects_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_covariate_effects</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">individual_effects_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_individual_effects</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexplained_variability_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_unexplained_variability</span><span class="p">()</span></div>

<div class="viewcode-block" id="FREMResults.plot_covariate_effects"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.FREMResults.plot_covariate_effects">[docs]</a>    <span class="k">def</span> <span class="nf">plot_covariate_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot covariate effects&quot;&quot;&quot;</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariate_effects</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">cov_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariate_statistics</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;covariate&#39;</span><span class="p">],</span>
            <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">cov_stats</span> <span class="o">=</span> <span class="n">cov_stats</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="s1">&#39;5th&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="s1">&#39;95th&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">ce</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cov_stats</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

        <span class="c1"># The left join reorders the index, pandas bug #34133</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">])</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">error_bars</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_errorbar</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;p5:Q&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Effect size in percent&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                    <span class="n">x2</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X2</span><span class="p">(</span><span class="s1">&#39;p95:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;condition:N&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">rule</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_rule</span><span class="p">(</span><span class="n">strokeDash</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;xzero:Q&#39;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span><span class="n">xzero</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_point</span><span class="p">(</span><span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;mean:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;condition:N&#39;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_text</span><span class="p">(</span><span class="n">dy</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s2">&quot;mean:Q&quot;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s2">&quot;condition:N&quot;</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;value:Q&quot;</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">error_bars</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Facet</span><span class="p">(</span><span class="s1">&#39;covariate:N&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resolve_scale</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">plots</span><span class="p">)</span><span class="o">.</span><span class="n">resolve_scale</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;shared&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="FREMResults.plot_individual_effects"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.FREMResults.plot_individual_effects">[docs]</a>    <span class="k">def</span> <span class="nf">plot_individual_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot individual effects&quot;&quot;&quot;</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_baselines</span>
        <span class="n">ie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">individual_effects</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">ie</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">ie</span> <span class="o">=</span> <span class="n">ie</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;observed&#39;</span><span class="p">])</span>

        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ie</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">id_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">id_order</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">id_order</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">id_order</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

            <span class="n">error_bars</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_errorbar</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;p5:Q&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Effect size in percent&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                    <span class="n">x2</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X2</span><span class="p">(</span><span class="s1">&#39;p95:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;ID:N&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">id_order</span><span class="p">),</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="s1">&#39;observed&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">covs</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">rule</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_rule</span><span class="p">(</span><span class="n">strokeDash</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;xzero:Q&#39;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span><span class="n">xzero</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;observed:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;ID:N&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">id_order</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span>
                <span class="n">points</span><span class="p">,</span>
                <span class="n">error_bars</span><span class="p">,</span>
                <span class="n">rule</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Individuals for parameter </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">plot</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">plot</span><span class="o">.</span><span class="n">transform_window</span><span class="p">(</span>
                        <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">alt</span><span class="o">.</span><span class="n">SortField</span><span class="p">(</span><span class="s1">&#39;observed&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;ascending&#39;</span><span class="p">)],</span>
                        <span class="n">rank</span><span class="o">=</span><span class="s1">&#39;row_number(observed)&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">transform_window</span><span class="p">(</span>
                        <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">alt</span><span class="o">.</span><span class="n">SortField</span><span class="p">(</span><span class="s1">&#39;observed&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;descending&#39;</span><span class="p">)],</span>
                        <span class="n">nrank</span><span class="o">=</span><span class="s1">&#39;row_number(observed)&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="s1">&#39;datum.rank &lt;= 10 | datum.nrank &lt;= 11&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
                        <span class="n">ID</span><span class="o">=</span><span class="s2">&quot;datum.nrank == 11 ? &#39;...&#39; : datum.ID&quot;</span><span class="p">,</span>
                        <span class="n">p5</span><span class="o">=</span><span class="s2">&quot;datum.nrank == 11 ? &#39;...&#39; : datum.p5&quot;</span><span class="p">,</span>
                        <span class="n">p95</span><span class="o">=</span><span class="s2">&quot;datum.nrank == 11 ? &#39;...&#39; : datum.p95&quot;</span><span class="p">,</span>
                        <span class="n">observed</span><span class="o">=</span><span class="s2">&quot;datum.nrank == 11 ? &#39;...&#39; : datum.observed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">plots</span><span class="p">)</span><span class="o">.</span><span class="n">resolve_scale</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;shared&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="FREMResults.plot_unexplained_variability"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.FREMResults.plot_unexplained_variability">[docs]</a>    <span class="k">def</span> <span class="nf">plot_unexplained_variability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot unexplained variability&quot;&quot;&quot;</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unexplained_variability</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">cov_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;covariate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">uv</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">error_bars</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_errorbar</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span>
                        <span class="s1">&#39;sd_5th:Q&#39;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SD of unexplained variability&#39;</span><span class="p">,</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">zero</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">x2</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X2</span><span class="p">(</span><span class="s1">&#39;sd_95th:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;covariate:N&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">cov_order</span><span class="p">),</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sd_5th&#39;</span><span class="p">,</span> <span class="s1">&#39;sd_observed&#39;</span><span class="p">,</span> <span class="s1">&#39;sd_95th&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">rule</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_rule</span><span class="p">(</span><span class="n">strokeDash</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;xzero:Q&#39;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span><span class="n">xzero</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;sd_observed:Q&#39;</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;covariate:N&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">cov_order</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span>
                <span class="n">points</span><span class="p">,</span>
                <span class="n">error_bars</span><span class="p">,</span>
                <span class="n">rule</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Unexplained variability on </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">plots</span><span class="p">)</span><span class="o">.</span><span class="n">resolve_scale</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;shared&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div></div>


<div class="viewcode-block" id="calculate_results"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.calculate_results">[docs]</a><span class="k">def</span> <span class="nf">calculate_results</span><span class="p">(</span>
    <span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intermediate_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate FREM results</span>

<span class="sd">    :param method: Either &#39;cov_sampling&#39; or &#39;bipp&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">intermediate_models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">intermediate_models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cov_sampling&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results_using_cov_sampling</span><span class="p">(</span>
                <span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Fallback to bipp</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results_using_bipp</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bipp&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results_using_bipp</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown frem postprocessing method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mod_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mod_ofvs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">intermediate_models</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">intmod</span> <span class="ow">in</span> <span class="n">intermediate_models</span><span class="p">:</span>
            <span class="n">intmod_res</span> <span class="o">=</span> <span class="n">intmod</span><span class="o">.</span><span class="n">modelfit_results</span>
            <span class="k">if</span> <span class="n">intmod_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mod_ofvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intmod_res</span><span class="o">.</span><span class="n">ofv</span><span class="p">)</span>
                <span class="n">mod_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intmod</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">mod_ofvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">ofv</span><span class="p">)</span>
    <span class="n">mod_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ofv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;ofv&#39;</span><span class="p">:</span> <span class="n">mod_ofvs</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">mod_names</span><span class="p">)</span>
    <span class="n">ofv</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;model_name&#39;</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ofv</span> <span class="o">=</span> <span class="n">ofv</span>

    <span class="n">add_parameter_inits_and_estimates</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">frem_model</span><span class="p">,</span> <span class="n">intermediate_models</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">intermediate_models</span><span class="p">:</span>
        <span class="n">add_base_vs_frem_model</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">frem_model</span><span class="p">,</span> <span class="n">intermediate_models</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">estimated_covbase</span> <span class="o">=</span> <span class="n">_calculate_covariate_baselines</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span> <span class="o">+</span> <span class="n">categorical</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">estimated_covbase</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">estimated_covbase</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">estcovs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="p">,</span> <span class="s1">&#39;stdev&#39;</span><span class="p">:</span> <span class="n">stdev</span><span class="p">})</span>
    <span class="n">res</span><span class="o">.</span><span class="n">estimated_covariates</span> <span class="o">=</span> <span class="n">estcovs</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="add_base_vs_frem_model"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.add_base_vs_frem_model">[docs]</a><span class="k">def</span> <span class="nf">add_base_vs_frem_model</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">frem_model</span><span class="p">,</span> <span class="n">model_1</span><span class="p">):</span>
    <span class="n">base_ests</span> <span class="o">=</span> <span class="n">model_1</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span>
    <span class="n">final_ests</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">base_ests</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ser</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_ests</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_ests</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">base_ests</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">ser</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;relative_change&#39;</span>
    <span class="n">res</span><span class="o">.</span><span class="n">base_parameter_change</span> <span class="o">=</span> <span class="n">ser</span></div>


<div class="viewcode-block" id="add_parameter_inits_and_estimates"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.add_parameter_inits_and_estimates">[docs]</a><span class="k">def</span> <span class="nf">add_parameter_inits_and_estimates</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">frem_model</span><span class="p">,</span> <span class="n">intermediate_models</span><span class="p">):</span>
    <span class="n">model_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">intermediate_models</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">nonfixed_inits</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="n">model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">nonfixed_inits</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">frem_model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">nonfixed_inits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">model_names</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;estimate&#39;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="n">res</span><span class="o">.</span><span class="n">parameter_inits_and_estimates</span> <span class="o">=</span> <span class="n">df</span></div>


<div class="viewcode-block" id="calculate_results_using_cov_sampling"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.calculate_results_using_cov_sampling">[docs]</a><span class="k">def</span> <span class="nf">calculate_results_using_cov_sampling</span><span class="p">(</span>
    <span class="n">frem_model</span><span class="p">,</span>
    <span class="n">continuous</span><span class="p">,</span>
    <span class="n">categorical</span><span class="p">,</span>
    <span class="n">cov_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_posdef_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">force_posdef_covmatrix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the FREM results using covariance matrix for uncertainty</span>

<span class="sd">    :param cov_model: Take the parameter uncertainty covariance matrix from this model</span>
<span class="sd">                      instead of the frem model.</span>
<span class="sd">    :param force_posdef_samples: The number of sampling tries before stopping to use</span>
<span class="sd">                                 rejection sampling and instead starting to shift values so</span>
<span class="sd">                                 that the frem matrix becomes positive definite. Set to 0 to</span>
<span class="sd">                                 always force positive definiteness.</span>
<span class="sd">    :param force_posdef_covmatrix: Set to force the covariance matrix of the frem movdel or</span>
<span class="sd">                                   the cov model to be positive definite. Default is to raise</span>
<span class="sd">                                   in this case.</span>
<span class="sd">    :param samples: The number of parameter vector samples to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cov_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">uncertainty_results</span> <span class="o">=</span> <span class="n">cov_model</span><span class="o">.</span><span class="n">modelfit_results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uncertainty_results</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">random_variables</span><span class="o">.</span><span class="n">distributions</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">VariabilityLevel</span><span class="o">.</span><span class="n">IIV</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sigma_symb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">sigma</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">symbols</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sigma_symb</span><span class="o">.</span><span class="n">free_symbols</span>
    <span class="p">]</span>
    <span class="n">parvecs</span> <span class="o">=</span> <span class="n">sample_from_covariance_matrix</span><span class="p">(</span>
        <span class="n">frem_model</span><span class="p">,</span>
        <span class="n">modelfit_results</span><span class="o">=</span><span class="n">uncertainty_results</span><span class="p">,</span>
        <span class="n">force_posdef_samples</span><span class="o">=</span><span class="n">force_posdef_samples</span><span class="p">,</span>
        <span class="n">force_posdef_covmatrix</span><span class="o">=</span><span class="n">force_posdef_covmatrix</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results_from_samples</span><span class="p">(</span>
        <span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">parvecs</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="calculate_results_from_samples"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.calculate_results_from_samples">[docs]</a><span class="k">def</span> <span class="nf">calculate_results_from_samples</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">parvecs</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the FREM results given samples of parameter estimates&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parvecs</span><span class="p">)</span>
    <span class="n">rvs</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">random_variables</span><span class="o">.</span><span class="n">distributions</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">VariabilityLevel</span><span class="o">.</span><span class="n">IIV</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sigma_symb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">sigma</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">symbols</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sigma_symb</span><span class="o">.</span><span class="n">free_symbols</span>
    <span class="p">]</span>
    <span class="n">parvecs</span> <span class="o">=</span> <span class="n">parvecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parameters</span><span class="p">])</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">dataset</span>
    <span class="n">covariates</span> <span class="o">=</span> <span class="n">continuous</span> <span class="o">+</span> <span class="n">categorical</span>
    <span class="n">df</span><span class="o">.</span><span class="n">pharmpy</span><span class="o">.</span><span class="n">column_type</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">COVARIATE</span>
    <span class="n">covariate_baselines</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pharmpy</span><span class="o">.</span><span class="n">covariate_baselines</span>
    <span class="n">covariate_baselines</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
    <span class="n">cov_means</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">cov_modes</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Select first mode if more than one</span>
    <span class="n">cov_others</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cov_modes</span><span class="p">[</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cov_stdevs</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">categorical</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cov_modes</span><span class="p">[</span><span class="n">cov</span><span class="p">]:</span>
                <span class="n">cov_others</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cov_others</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">break</span>

    <span class="n">cov_refs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">cov_means</span><span class="p">[</span><span class="n">continuous</span><span class="p">],</span> <span class="n">cov_modes</span><span class="p">[</span><span class="n">categorical</span><span class="p">]))</span>
    <span class="n">cov_5th</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cov_95th</span> <span class="o">=</span> <span class="n">covariate_baselines</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;higher&#39;</span><span class="p">)</span>
    <span class="n">is_categorical</span> <span class="o">=</span> <span class="n">cov_refs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">categorical</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">FREMResults</span><span class="p">()</span>

    <span class="n">res</span><span class="o">.</span><span class="n">covariate_statistics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="n">cov_5th</span><span class="p">,</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">cov_means</span><span class="p">,</span>
            <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="n">cov_95th</span><span class="p">,</span>
            <span class="s1">&#39;stdev&#39;</span><span class="p">:</span> <span class="n">cov_stdevs</span><span class="p">,</span>
            <span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="n">cov_refs</span><span class="p">,</span>
            <span class="s1">&#39;categorical&#39;</span><span class="p">:</span> <span class="n">is_categorical</span><span class="p">,</span>
            <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="n">cov_others</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">covariate_statistics</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;covariate&#39;</span>

    <span class="n">ncovs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span>
    <span class="n">npars</span> <span class="o">=</span> <span class="n">sigma_symb</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="n">ncovs</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">npars</span><span class="p">)</span>
    <span class="n">nids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covariate_baselines</span><span class="p">)</span>
    <span class="n">param_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">npars</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npars</span><span class="p">),</span> <span class="n">cov_stdevs</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>

    <span class="n">mu_bars_given_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncovs</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
    <span class="n">mu_bars_given_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncovs</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
    <span class="n">mu_id_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
    <span class="n">original_id_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nids</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
    <span class="n">variability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">ncovs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>  <span class="c1"># none, cov1, cov2, ..., all</span>
    <span class="n">original_variability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ncovs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">npars</span><span class="p">))</span>
    <span class="n">coefficients_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;each&#39;</span><span class="p">],</span> <span class="n">param_names</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">coefficients_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">parameter_variability</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Switch to symengine for speed</span>
    <span class="c1"># Could also assume order of parameters, but not much gain</span>
    <span class="n">sigma_symb</span> <span class="o">=</span> <span class="n">symengine</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">sigma_symb</span><span class="p">)</span>
    <span class="n">parvecs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">symengine</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">parvecs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="n">estimated_covbase</span> <span class="o">=</span> <span class="n">_calculate_covariate_baselines</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">covariates</span><span class="p">)</span>
    <span class="n">covbase</span> <span class="o">=</span> <span class="n">estimated_covbase</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">sample_no</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">parvecs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_symb</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">scaling</span> <span class="o">@</span> <span class="n">sigma</span> <span class="o">@</span> <span class="n">scaling</span>
        <span class="k">if</span> <span class="n">sample_no</span> <span class="o">!=</span> <span class="s1">&#39;estimates&#39;</span><span class="p">:</span>
            <span class="n">variability</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">)[:</span><span class="n">npars</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_variability</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">)[:</span><span class="n">npars</span><span class="p">]</span>
            <span class="c1"># Coefficients conditioned on all parameters</span>
            <span class="c1"># Sigma_12 * Sigma_22^-1</span>
            <span class="n">coeffs_all</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npars</span><span class="p">,</span> <span class="n">npars</span><span class="p">:]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="n">npars</span><span class="p">:,</span> <span class="n">npars</span><span class="p">:])</span>
            <span class="n">coefficients</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs_all</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">covariates</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">param_indices</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">npars</span><span class="p">]</span>
            <span class="n">cov_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">indices</span><span class="p">][:,</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">cov_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">npars</span> <span class="o">+</span> <span class="p">[</span><span class="n">cov_refs</span><span class="p">[</span><span class="n">cov</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">categorical</span><span class="p">:</span>
                <span class="n">first_reference</span> <span class="o">=</span> <span class="n">cov_others</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_reference</span> <span class="o">=</span> <span class="n">cov_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span>
            <span class="n">mu_bar_given_5th_cov</span><span class="p">,</span> <span class="n">sigma_bar</span> <span class="o">=</span> <span class="n">conditional_joint_normal</span><span class="p">(</span>
                <span class="n">cov_mu</span><span class="p">,</span> <span class="n">cov_sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">first_reference</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sample_no</span> <span class="o">!=</span> <span class="s1">&#39;estimates&#39;</span><span class="p">:</span>
                <span class="n">mu_bar_given_95th_cov</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">conditional_joint_normal</span><span class="p">(</span>
                    <span class="n">cov_mu</span><span class="p">,</span> <span class="n">cov_sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cov_95th</span><span class="p">[</span><span class="n">cov</span><span class="p">]])</span>
                <span class="p">)</span>
                <span class="n">mu_bars_given_5th</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mu_bar_given_5th_cov</span>
                <span class="n">mu_bars_given_95th</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mu_bar_given_95th_cov</span>
                <span class="n">variability</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_bar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">original_variability</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_bar</span><span class="p">)</span>
                <span class="n">parameter_variability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma_bar</span><span class="p">)</span>
                <span class="c1"># Calculate coefficients</span>
                <span class="c1"># Cov(Par, covariate) / Var(covariate)</span>
                <span class="k">for</span> <span class="n">parind</span><span class="p">,</span> <span class="n">parname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
                    <span class="n">coefficients</span><span class="p">[</span><span class="n">cov</span><span class="p">][</span><span class="s1">&#39;each&#39;</span><span class="p">,</span> <span class="n">parname</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_sigma</span><span class="p">[</span><span class="n">parind</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">cov_sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">estimated_covbase</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">covbase</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">id_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">npars</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cov_refs</span><span class="p">))</span>
            <span class="n">mu_id_bar</span><span class="p">,</span> <span class="n">sigma_id_bar</span> <span class="o">=</span> <span class="n">conditional_joint_normal</span><span class="p">(</span><span class="n">id_mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sample_no</span> <span class="o">!=</span> <span class="s1">&#39;estimates&#39;</span><span class="p">:</span>
                <span class="n">mu_id_bars</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mu_id_bar</span>
                <span class="n">variability</span><span class="p">[</span><span class="n">sample_no</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_id_bar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">original_id_bar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mu_id_bar</span>
                <span class="n">original_variability</span><span class="p">[</span><span class="n">ncovs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_id_bar</span><span class="p">)</span>
                <span class="n">parameter_variability_all</span> <span class="o">=</span> <span class="n">sigma_id_bar</span>

    <span class="n">res</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span>

    <span class="c1"># Create covariate effects table</span>
    <span class="n">mu_bars_given_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_bars_given_5th</span><span class="p">)</span>
    <span class="n">mu_bars_given_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_bars_given_95th</span><span class="p">)</span>

    <span class="n">means_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_bars_given_5th</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">means_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_bars_given_95th</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">q5_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mu_bars_given_5th</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">q5_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mu_bars_given_95th</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">q95_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mu_bars_given_5th</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">q95_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mu_bars_given_95th</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">npars</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">covariates</span><span class="p">[</span><span class="n">cov</span><span class="p">]</span> <span class="ow">in</span> <span class="n">categorical</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_names</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;covariate&#39;</span><span class="p">:</span> <span class="n">covariates</span><span class="p">[</span><span class="n">cov</span><span class="p">],</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="n">q5_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">means_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="n">q95_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_names</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;covariate&#39;</span><span class="p">:</span> <span class="n">covariates</span><span class="p">[</span><span class="n">cov</span><span class="p">],</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;5th&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="n">q5_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">means_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="n">q95_5th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_names</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;covariate&#39;</span><span class="p">:</span> <span class="n">covariates</span><span class="p">[</span><span class="n">cov</span><span class="p">],</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;95th&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="n">q5_95th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">means_95th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="n">q95_95th</span><span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">covariate_effects</span> <span class="o">=</span> <span class="n">df</span>

    <span class="c1"># Create id table</span>
    <span class="n">mu_id_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu_id_bars</span><span class="p">)</span>
    <span class="n">original_id_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">original_id_bar</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">suppress_warnings</span><span class="p">()</span> <span class="k">as</span> <span class="n">sup</span><span class="p">:</span>  <span class="c1"># Would warn in case of missing covariates</span>
        <span class="n">sup</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="s2">&quot;All-NaN slice encountered&quot;</span><span class="p">)</span>
        <span class="n">id_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">mu_id_bars</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">id_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">mu_id_bars</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;observed&#39;</span><span class="p">,</span> <span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">curid</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nids</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">npars</span><span class="p">)):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_names</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">original_id_bar</span><span class="p">[</span><span class="n">curid</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;p5&#39;</span><span class="p">:</span> <span class="n">id_5th</span><span class="p">[</span><span class="n">curid</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                    <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="n">id_95th</span><span class="p">[</span><span class="n">curid</span><span class="p">,</span> <span class="n">param</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="n">name</span><span class="o">=</span><span class="n">covariate_baselines</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">curid</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ID&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">individual_effects</span> <span class="o">=</span> <span class="n">df</span>

    <span class="c1"># Create unexplained variability table</span>
    <span class="n">sd_5th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">variability</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">sd_95th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">variability</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">original_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">original_variability</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">,</span> <span class="s1">&#39;sd_observed&#39;</span><span class="p">,</span> <span class="s1">&#39;sd_5th&#39;</span><span class="p">,</span> <span class="s1">&#39;sd_95th&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">npars</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">cond</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">elif</span> <span class="n">cond</span> <span class="o">==</span> <span class="n">ncovs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">cond</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_names</span><span class="p">[</span><span class="n">par</span><span class="p">],</span>
                <span class="s1">&#39;covariate&#39;</span><span class="p">:</span> <span class="n">condition</span><span class="p">,</span>
                <span class="s1">&#39;sd_observed&#39;</span><span class="p">:</span> <span class="n">original_sd</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">par</span><span class="p">],</span>
                <span class="s1">&#39;sd_5th&#39;</span><span class="p">:</span> <span class="n">sd_5th</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">par</span><span class="p">],</span>
                <span class="s1">&#39;sd_95th&#39;</span><span class="p">:</span> <span class="n">sd_95th</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">par</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;covariate&#39;</span><span class="p">])</span>
    <span class="n">res</span><span class="o">.</span><span class="n">unexplained_variability</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">res</span><span class="o">.</span><span class="n">covariate_baselines</span> <span class="o">=</span> <span class="n">covariate_baselines</span>

    <span class="c1"># Create frem_parameter_variability</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">covariates</span><span class="p">,</span> <span class="n">param_names</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">param_names</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parameter_variability_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">covariates</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">param_names</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parameter_variability</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="n">res</span><span class="o">.</span><span class="n">parameter_variability</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_params"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.get_params">[docs]</a><span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">npars</span><span class="p">):</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">rv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">rvs</span><span class="p">][:</span><span class="n">npars</span><span class="p">]</span>
    <span class="n">sset</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">statements</span><span class="o">.</span><span class="n">before_ode</span><span class="p">()</span>
    <span class="n">symbs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sset</span><span class="o">.</span><span class="n">find_assignment</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">is_symbol</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sset</span><span class="o">.</span><span class="n">find_assignment</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">is_symbol</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">symbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">symbs</span> <span class="k">if</span> <span class="n">symbs</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">symbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rename_duplicate</span><span class="p">(</span><span class="n">symbs</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">symbs</span></div>


<div class="viewcode-block" id="rename_duplicate"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.rename_duplicate">[docs]</a><span class="k">def</span> <span class="nf">rename_duplicate</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stem</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stem</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>


<span class="k">def</span> <span class="nf">_calculate_covariate_baselines</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">covariates</span><span class="p">):</span>
    <span class="n">exprs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ass</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">statements</span>
        <span class="k">if</span> <span class="n">symbols</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s1">&#39;FREMTYPE&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ass</span><span class="o">.</span><span class="n">free_symbols</span> <span class="ow">and</span> <span class="n">ass</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;IPRED&#39;</span>
    <span class="p">]</span>
    <span class="n">exprs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span><span class="p">))</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">inits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span>
    <span class="p">]</span>
    <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">statements</span><span class="o">.</span><span class="n">find_assignment</span><span class="p">(</span><span class="n">symb</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symb</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="n">exprs</span> <span class="o">=</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)))</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">individual_estimates</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">covariates</span>
    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="calculate_results_using_bipp"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.calculate_results_using_bipp">[docs]</a><span class="k">def</span> <span class="nf">calculate_results_using_bipp</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate a covariance matrix for the frem model using the BIPP method</span>

<span class="sd">    Bootstrap on the individual parameter posteriors</span>
<span class="sd">    Only the individual estimates, individual unvertainties and the parameter estimates</span>
<span class="sd">    are needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rvs</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">random_variables</span><span class="o">.</span><span class="n">distributions</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">VariabilityLevel</span><span class="o">.</span><span class="n">IIV</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">etas</span> <span class="o">=</span> <span class="p">[</span><span class="n">rv</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">rvs</span><span class="p">]</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">sample_individual_estimates</span><span class="p">(</span><span class="n">frem_model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">etas</span><span class="p">)</span>
    <span class="n">ninds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">ishr</span> <span class="o">=</span> <span class="n">frem_model</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">individual_shrinkage</span>
    <span class="n">lower_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">etas</span><span class="p">))</span>
    <span class="n">pop_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)[</span><span class="n">lower_indices</span><span class="p">]</span>
    <span class="n">parameter_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pop_params</span><span class="p">)))</span>
    <span class="n">remaining_samples</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">remaining_samples</span><span class="p">:</span>
        <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ninds</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ishk</span> <span class="o">=</span> <span class="n">ishr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ishk</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">corrected_bootstrap</span> <span class="o">=</span> <span class="n">bootstrap</span> <span class="o">*</span> <span class="n">cf</span>
        <span class="n">bootstrap_cov</span> <span class="o">=</span> <span class="n">corrected_bootstrap</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_posdef</span><span class="p">(</span><span class="n">bootstrap_cov</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()):</span>
            <span class="k">continue</span>
        <span class="n">parameter_samples</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bootstrap_cov</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">lower_indices</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameter_samples</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pop_params</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results_from_samples</span><span class="p">(</span>
        <span class="n">frem_model</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="psn_reorder_base_model_inits"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.psn_reorder_base_model_inits">[docs]</a><span class="k">def</span> <span class="nf">psn_reorder_base_model_inits</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reorder omega inits from base model in PsN</span>

<span class="sd">    If base model was reordered PsN writes the omega inits dict to m1/model_1.inits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;m1&#39;</span> <span class="o">/</span> <span class="s1">&#39;model_1.inits&#39;</span>
    <span class="k">if</span> <span class="n">order_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">order_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">replacements</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">sortfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span>

        <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">replacements</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sortfunc</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">replacements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">random_variables</span><span class="o">.</span><span class="n">all_parameters</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="psn_frem_results"><a class="viewcode-back" href="../../../../reference/pharmpy.methods.frem.results.html#pharmpy.methods.frem.psn_frem_results">[docs]</a><span class="k">def</span> <span class="nf">psn_frem_results</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force_posdef_covmatrix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_posdef_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create frem results from a PsN FREM run</span>

<span class="sd">    :param path: Path to PsN frem run directory</span>
<span class="sd">    :return: A :class:`FREMResults` object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">model_4_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;final_models&#39;</span> <span class="o">/</span> <span class="s1">&#39;model_4.mod&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_4_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find FREM model 4: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_4_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model_4</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model_4_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_4</span><span class="o">.</span><span class="n">modelfit_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Model 4 has no results&#39;</span><span class="p">)</span>
    <span class="n">cov_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cov_sampling&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_4</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">covariance_matrix</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">model_4b_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;final_models&#39;</span> <span class="o">/</span> <span class="s1">&#39;model_4b.mod&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_4b</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model_4b_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov_model</span> <span class="o">=</span> <span class="n">model_4b</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;covariates_summary.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">covsum</span><span class="p">:</span>
        <span class="n">covsum</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">raw_cov_list</span> <span class="o">=</span> <span class="n">covsum</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">all_covariates</span> <span class="o">=</span> <span class="n">raw_cov_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># FIXME: Not introducing yaml parser in pharmpy just yet. Options should be collected</span>
    <span class="c1"># differently. Perhaps using json</span>
    <span class="n">logtransformed_covariates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rescale: 1&#39;</span><span class="p">):</span>
                <span class="n">rescale</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rescale: 0&#39;</span><span class="p">):</span>
                <span class="n">rescale</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;log: &#39;&#39;&quot;</span><span class="p">):</span>
                <span class="n">logtransformed_covariates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log: &#39;</span><span class="p">):</span>
                <span class="n">logtransformed_covariates</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># add log transformed columns for the -log option. Should be done when creating dataset</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">model_4</span><span class="o">.</span><span class="n">dataset</span>
    <span class="k">if</span> <span class="n">logtransformed_covariates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lncov</span> <span class="ow">in</span> <span class="n">logtransformed_covariates</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;LN</span><span class="si">{</span><span class="n">lncov</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lncov</span><span class="p">])</span>
        <span class="n">model_4</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">nunique</span> <span class="o">=</span> <span class="n">model_4</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">pharmpy</span><span class="o">.</span><span class="n">baselines</span><span class="p">[</span><span class="n">all_covariates</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">continuous</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nunique</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">nunique</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">categorical</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nunique</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">nunique</span> <span class="o">==</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">intmod_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model_1.mod&#39;</span><span class="p">,</span> <span class="s1">&#39;model_2.mod&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3.mod&#39;</span><span class="p">,</span> <span class="s1">&#39;model_3b.mod&#39;</span><span class="p">]</span>
    <span class="n">intmods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">intmod_names</span><span class="p">:</span>
        <span class="n">intmod_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;m1&#39;</span> <span class="o">/</span> <span class="n">m</span>
        <span class="k">if</span> <span class="n">intmod_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">intmod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">intmod_path</span><span class="p">)</span>
            <span class="n">intmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intmod</span><span class="p">)</span>

    <span class="n">model1b</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s1">&#39;m1&#39;</span> <span class="o">/</span> <span class="s1">&#39;model_1b.mod&#39;</span><span class="p">)</span>
    <span class="n">model1</span> <span class="o">=</span> <span class="n">intmods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model1b</span><span class="o">.</span><span class="n">modelfit_results</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">modelfit_results</span>
    <span class="n">model1b</span><span class="o">.</span><span class="n">modelfit_results</span><span class="o">.</span><span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">model1b</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">nonfixed_inits</span>
    <span class="n">psn_reorder_base_model_inits</span><span class="p">(</span><span class="n">model1b</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">calculate_results</span><span class="p">(</span>
        <span class="n">model_4</span><span class="p">,</span>
        <span class="n">continuous</span><span class="p">,</span>
        <span class="n">categorical</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">force_posdef_covmatrix</span><span class="o">=</span><span class="n">force_posdef_covmatrix</span><span class="p">,</span>
        <span class="n">force_posdef_samples</span><span class="o">=</span><span class="n">force_posdef_samples</span><span class="p">,</span>
        <span class="n">cov_model</span><span class="o">=</span><span class="n">cov_model</span><span class="p">,</span>
        <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span>
        <span class="n">intermediate_models</span><span class="o">=</span><span class="n">intmods</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../../../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018-2020; the Pharmpy development team.<br/>
        Last updated on Mar 11, 2021.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>