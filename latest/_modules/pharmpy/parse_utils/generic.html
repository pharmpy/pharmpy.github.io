
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pharmpy.parse_utils.generic &#8212; Pharmpy 0.22.10 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.ee6fb81b276d6fba8a971ad8e9b95dd9.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.c86189f1ce1b71a67eb6.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">Pharmpy</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../reference/modules.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contribute.html">
  Contribute
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../changelog.html">
  Changelog
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../license.html">
  License
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/modules.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                

<nav id="bd-toc-nav">
    
</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pharmpy.parse_utils.generic</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generic parser using lark-parser.</span>

<span class="sd">Subclass :class:`GenericParser` (remember to set :attr:`GenericParser.grammar`</span>
<span class="sd">to point to your grammar file) to define a powerful parser.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">lark</span> <span class="kn">import</span> <span class="n">Tree</span>
<span class="kn">from</span> <span class="nn">lark.lexer</span> <span class="kn">import</span> <span class="n">Token</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">prettyprint</span>


<div class="viewcode-block" id="NoSuchRuleException"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.NoSuchRuleException">[docs]</a><span class="k">class</span> <span class="nc">NoSuchRuleException</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rule not found (raised by :class:`AttrTree` for unknown children).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">rule</span><span class="p">),)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;no </span><span class="si">%s</span><span class="s1"> child in tree</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">rule</span><span class="p">),</span> <span class="n">post</span><span class="p">))</span></div>


<div class="viewcode-block" id="rule_of"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.rule_of">[docs]</a><span class="k">def</span> <span class="nf">rule_of</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rule of a tree or token. Convenience function (will not raise).&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="empty_rule"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.empty_rule">[docs]</a><span class="k">def</span> <span class="nf">empty_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create empty Tree or Token, depending on (all) upper-case or not.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Token</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Tree</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="AttrToken"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrToken">[docs]</a><span class="k">class</span> <span class="nc">AttrToken</span><span class="p">(</span><span class="n">Token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Token with attribute access.</span>

<span class="sd">    Created by :meth:`AttrTree.transform` from :class:`lark.lexer.Token`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        self.rule: Name, in common with :class:`AttrTree`.</span>
<span class="sd">        self.eval: Transformed data type, in common with :class:`AttrTree`.</span>

<span class="sd">    Can be instantiated with :meth:`.__init__`(rule, content), via :class:`lark.lexer.Token`, or</span>
<span class="sd">    alternative constructor :meth:`.transform` (transform object of class</span>
<span class="sd">    :class:`lark.lexer.Token`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="AttrToken.transform"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrToken.transform">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative constructor: From Token (with optional overrides).&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type_&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;pos_in_stream&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">pos_in_stream</span><span class="p">,</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
            <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rule name (synonymous with &#39;type&#39;)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>

    <span class="nd">@rule</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluated value (str, int, float).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;DIGIT&#39;</span><span class="p">,</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span> <span class="s1">&#39;SIGNED_INT&#39;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s1">&#39;DECIMAL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EXP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NUMBER&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NUMERIC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SIGNED_FLOAT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SIGNED_NUMBER&#39;</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;NEG_INF&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-INF&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;POS_INF&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;INF&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="AttrToken.replace"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrToken.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns copy (same rule), but with content replaced.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AttrToken</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_in_stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="AttrTree"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree">[docs]</a><span class="k">class</span> <span class="nc">AttrTree</span><span class="p">(</span><span class="n">Tree</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tree with attribute access.</span>

<span class="sd">    Created in :meth:`GenericParser.parse` by :meth:`transform`, from :class:`lark.Tree`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        self.rule: Name, in common with :class:`.AttrToken`.</span>
<span class="sd">        self.rules: Names of children.</span>
<span class="sd">        self.eval: Transformed data type, in common with :class:`.AttrToken`.</span>
<span class="sd">        self.tokens: Recursive tokens as (flattened) list.</span>
<span class="sd">        self.debug: Treeview str, formatted for debugging.</span>

<span class="sd">    Can be instantiated with :meth:`.__init__`, via :class:`lark.Tree`, or alternative constructors:</span>
<span class="sd">        1. :meth:`.transform` (transform recursively object of class :class:`lark.Tree`).</span>
<span class="sd">        2. :meth:`.create` (create from nested iterators).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AttrToken</span> <span class="o">=</span> <span class="n">AttrToken</span>

<div class="viewcode-block" id="AttrTree.transform"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.transform">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative constructor: From Tree (with optional overrides).&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">tree</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="n">tree</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">tree</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Tree</span><span class="p">):</span>
                <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">child</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span>
                <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AttrToken</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">child</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">AttrToken</span><span class="p">(</span><span class="s1">&#39;STRING&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">children</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.create"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">_anon_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative constructor: Creates new tree from (possibly nested) iterables.</span>

<span class="sd">        Only non-iterable items become leaves (i.e. content of token nodes). All others are trees.</span>

<span class="sd">        Handling of missing names (e.g. lists):</span>
<span class="sd">            1. Tree: Children are moved to parent.</span>
<span class="sd">            2. Token: Native naming scheme, __ANON_%d, of Lark is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            items: Child (tree) nodes or content (token) nodes.</span>
<span class="sd">            rule: Name of root tree (__ANON_0 if False).</span>
<span class="sd">            _anon_count: Internal. Anonymous numbering offset.</span>
<span class="sd">            _list: Internal. Recursion state. Drop &#39;rule&#39; &amp; return list of children, which are</span>
<span class="sd">                orphaned if name is False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: &#39;items&#39; not iterable or instance of &#39;str&#39; (only leaves shall contain &#39;str&#39;).</span>
<span class="sd">            ValueError: &#39;items&#39; empty (trees can&#39;t be empty).</span>

<span class="sd">        .. note:: Please follow convention of all lower/upper case for trees/tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">non_iterable</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> object is not iterable (of children for tree </span><span class="si">%s</span><span class="s1">)&#39;</span>
                <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">rule</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># determine mode of operation; &#39;items&#39; dict-like OR just iterable?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span><span class="p">,</span> <span class="n">items</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">non_iterable</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">non_iterable</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;refusing empty tree </span><span class="si">%s</span><span class="s1"> (only tokens are childless)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rule</span><span class="p">))</span>

        <span class="c1"># create the nodes</span>
        <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># try to recurse down</span>
                <span class="n">nodes</span><span class="p">,</span> <span class="n">_anon_count</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">_anon_count</span><span class="o">=</span><span class="n">_anon_count</span><span class="p">,</span> <span class="n">_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># looks like a leaf</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1"># don&#39;t convert existing nodes (to leaves)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">rule</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                        <span class="n">_anon_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;__ANON_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_anon_count</span><span class="p">,)</span>
                    <span class="n">new_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">AttrToken</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">thing</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># node already, won&#39;t recreate</span>
                    <span class="n">new_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">thing</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_nodes</span> <span class="o">+=</span> <span class="n">nodes</span>
        <span class="c1"># list (and counter) for recursion</span>
        <span class="k">if</span> <span class="n">_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">)]</span> <span class="k">if</span> <span class="n">rule</span> <span class="k">else</span> <span class="n">new_nodes</span><span class="p">,</span> <span class="n">_anon_count</span>

        <span class="c1"># tree to external caller</span>
        <span class="k">if</span> <span class="n">rule</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s1">&#39;__ANON_0&#39;</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">)</span></div>

    <span class="c1"># -- public interface ----------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rule name (synonymous with &#39;data&#39;).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@rule</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All rules of (immediate) children.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">rule</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluated value (self).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="AttrTree.find"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns first child matching &#39;rule&#39;, or None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.all"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns all children matching rule, or [].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">child</span><span class="p">:</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))</span></div>

<div class="viewcode-block" id="AttrTree.set"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets first child matching rule. Raises if none.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
        <span class="k">raise</span> <span class="n">NoSuchRuleException</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.partition"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.partition">[docs]</a>    <span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Partition children into (head, item, tail).</span>

<span class="sd">        Search for child item &#39;rule&#39; and return the part before it (head), the item, and the part</span>
<span class="sd">        after it (tail). If &#39;rule&#39; is not found, return (children, [], []).&quot;&quot;&quot;</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">+=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">+=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tail</span> <span class="o">+=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.tree_walk"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.tree_walk">[docs]</a>    <span class="k">def</span> <span class="nf">tree_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for iterating depth-first (i.e. parse order) over children.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">child</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">child</span><span class="o">.</span><span class="n">tree_walk</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="AttrTree.remove"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all children with rule. Not recursively&quot;&quot;&quot;</span>
        <span class="n">new_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">!=</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_children</span></div>

<div class="viewcode-block" id="AttrTree.remove_node"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.remove_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">new_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">comment_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;COMMENT&#39;</span> <span class="ow">or</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;NEWLINE&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_flag</span><span class="p">:</span>
                    <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">):</span>
                        <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>
                    <span class="n">comment_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">eval</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">eval</span><span class="p">):</span>
                <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;statement&#39;</span><span class="p">:</span>
                    <span class="n">comment_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comment_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_children</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_newline_node</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">AttrToken</span><span class="p">(</span><span class="s1">&#39;WS_ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_children</span><span class="p">):</span>
        <span class="n">new_children_clean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">types_of_newline</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WS_ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;NEWLINE&#39;</span><span class="p">]</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_children</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">prev_rule</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_children</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span> <span class="ow">in</span> <span class="n">types_of_newline</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prev_rule</span> <span class="ow">in</span> <span class="n">types_of_newline</span> <span class="ow">or</span> <span class="n">prev_rule</span> <span class="o">==</span> <span class="s1">&#39;verbatim&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">last_index</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{2,}&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="p">)):</span>
                <span class="n">new_children_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_newline_node</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_children_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="n">prev_rule</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">rule</span>

        <span class="k">return</span> <span class="n">new_children_clean</span>

<div class="viewcode-block" id="AttrTree.add_node"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">following_node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">new_children</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">new_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_ws</span><span class="p">(</span><span class="n">new_children</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">following_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
                <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_newline_node</span><span class="p">())</span>
            <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">following_node</span><span class="p">)</span>
            <span class="n">new_children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="n">newline_node</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_children</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">new_children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newline_node</span><span class="p">)</span>

        <span class="n">new_children_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_ws</span><span class="p">(</span><span class="n">new_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_children_clean</span></div>

<div class="viewcode-block" id="AttrTree.add_comment_node"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.add_comment_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_comment_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">adjacent_node</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">comment_node</span> <span class="o">=</span> <span class="n">AttrToken</span><span class="p">(</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39; ; </span><span class="si">{</span><span class="n">comment</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">comment_node</span><span class="p">,</span> <span class="n">adjacent_node</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.add_newline_node"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.add_newline_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_newline_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_newline_node</span><span class="p">())</span></div>

<div class="viewcode-block" id="AttrTree.get_last_node"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.get_last_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_last_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">last_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">last_node</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All tokens as flattened list.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="n">tokens</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">+=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">items</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debug formatted tree structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">prettyprint</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

<div class="viewcode-block" id="AttrTree.treeprint"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.treeprint">[docs]</a>    <span class="k">def</span> <span class="nf">treeprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints debug formatted tree structure.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span></div>

<div class="viewcode-block" id="AttrTree.set_child"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.AttrTree.set_child">[docs]</a>    <span class="k">def</span> <span class="nf">set_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></div>

    <span class="c1"># -- private methods -----------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">]:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_child</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoSuchRuleException</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">eval</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="GenericParser"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.GenericParser">[docs]</a><span class="k">class</span> <span class="nc">GenericParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic parser using lark-parser.</span>

<span class="sd">    Inherit to define a parser, say ThetaRecordParser for NONMEM, with the workflow:</span>

<span class="sd">    1. Lex and parse a &#39;buffer&#39; using Lark_ (from :attr:`grammar` file). Builds AST.</span>
<span class="sd">    2. Shape AST by options (see :attr:`non_empty`).</span>
<span class="sd">    3. Convert to :class:`AttrTree` for convenient traversal (attribute access).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        self.non_empty: Insert empty placeholders if missing. Dict of rule -&gt; (pos, name), where a</span>
<span class="sd">            Tree or Token (if uppercase) will be inserted at &#39;pos&#39; of the children of &#39;rule&#39;, if</span>
<span class="sd">            none exists.</span>
<span class="sd">        self.buffer: Buffer parsed by :meth:`parse`.</span>
<span class="sd">        self.grammar: Path to grammar file.</span>
<span class="sd">        self.root: Root of final tree. Instance of :class:`AttrTree`.</span>

<span class="sd">    .. _Lark:</span>
<span class="sd">        https://github.com/lark-parser/lark</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;Children to create if missing&quot;&quot;&quot;</span>
    <span class="n">non_empty</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="sd">&quot;&quot;&quot;:class:`AttrTree` implementation.&quot;&quot;&quot;</span>
    <span class="n">AttrTree</span> <span class="o">=</span> <span class="n">AttrTree</span>

    <span class="n">lark_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ambiguity</span><span class="o">=</span><span class="s1">&#39;resolve&#39;</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_all_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lexer</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">,</span>
        <span class="n">parser</span><span class="o">=</span><span class="s1">&#39;earley&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">lark_options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lark_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lark_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<div class="viewcode-block" id="GenericParser.parse"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.GenericParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses a buffer, transforms and constructs :class:`AttrTree` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            buf: Buffer to parse.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lark</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_empty</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_empty</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AttrTree</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">root</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenericParser.insert"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.GenericParser.insert">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">non_empty</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts missing Tree/Token amongst children (see :attr:`non_empty`).</span>

<span class="sd">        Args:</span>
<span class="sd">            item: Tree to recurse.</span>
<span class="sd">            non_empty: Dict of rule -&gt; (pos, name) tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">non_empty</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">non_empty</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">rule_of</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">rule_of</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">empty_rule</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">non_empty</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prettyprint</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">))</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_token_and_space"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.remove_token_and_space">[docs]</a><span class="k">def</span> <span class="nf">remove_token_and_space</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove all tokens with rule and any WS before it&quot;&quot;&quot;</span>
    <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;WS&#39;</span><span class="p">:</span>
                <span class="n">new_nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_nodes</span>
    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">):</span>
                <span class="n">remove_token_and_space</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="insert_before_or_at_end"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.insert_before_or_at_end">[docs]</a><span class="k">def</span> <span class="nf">insert_before_or_at_end</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert nodes before rule or if rule does not exist at end&quot;&quot;&quot;</span>
    <span class="n">kept</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">kept</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kept</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
        <span class="n">kept</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">kept</span></div>


<div class="viewcode-block" id="insert_after"><a class="viewcode-back" href="../../../reference/pharmpy.parse_utils.generic.html#pharmpy.parse_utils.insert_after">[docs]</a><span class="k">def</span> <span class="nf">insert_after</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert nodes after rule&quot;&quot;&quot;</span>
    <span class="n">kept</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="n">kept</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">kept</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">kept</span></div>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>
    
  <script src="../../../_static/js/index.c86189f1ce1b71a67eb6.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2018-2021; the Pharmpy development team.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>